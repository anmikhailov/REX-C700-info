# Upgraded REX-C700 with remote control (MQTT)

## Краткое руководство

### Возможности
* Работа в онлайн и оффлайн режиме
* Возможность сохранить до 6 пользовательских режимов в память (температура и время работы)
* Отображение текущей температуры на лицевой панели
* В режиме нагрева отображение попеременно заданной температуры и времени до завершения работы (в минутах)
* По окончанию работы режима подается звуковой сигнал, а также замыкается реле (для подключения доп. устройств) 
* Выбор реле подключения нагревателя (электромеханическое/твердотельное)
* Возможность подключения датчика тока для контроля обрыва линии
* В онлайн режиме
	* На брокер каждые 500 мс отправляются: текущая температура, состояние ИК датчика, значение с датчика тока

### Используемое железо и ПО
1. RaspberryPi или аналог (для установки mqtt брокера) + wi-fi роутер
2. Wemos D1 mini (ESP8266)
3. AVR AT90USB162
4. В качестве MQTT клиента на Android используется Lazy MQTT Free (отличие платной версии в отсутствии рекламы).

### Среда программирования
1. ArduinoIDE для Wemos D1 mini
2. Microchip Studio для AT90USB162

### Настройка MQTT брокера
#### Инструкция по установке Raspberry OS. 
Если на RaspPi уже установлена система и есть доступ к SSH подключению, то этот пункт можно пропустить.
1. Скачиваем putty для управления RaspPi из Windows через SSH. Скачиваем с официального [сайта](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html). Для подключения по ssh в linux достаточно набрать в терминале команду ```ssh 'имя пользователя'@'ip адрес'```
2. Скачиваем Raspberry Pi imager с официального [сайта](https://downloads.raspberrypi.org/imager/imager_1.4.exe)
3. Подключаем microSD карту к компьютеру
4. Форматируем microSD карту в формате FAT32 перед записью нового образа. Для этого нажимаем CHOOSE OS в окне Raspberry Pi Imager и выбираем Erase
5. Затем выбираем из списка свою карту. Нажимаем write. Запустится процесс форматирования. Это займет несколько минут
6. Затем снова нажимаем CHOOSE OS, выбираем образ системы которую хотим записать на свою карту (Raspberry OS)
7. Снова нажимаем CHOOSE SD CARD. Выбираем из списка свою карту. Нажимаем WRITE
8. Об окончании записи, Raspberry Pi Imager сообщит появлением диалогового окна. Нажимаем CONTINUE
9. Чтобы включить SSH без графического интерфейса переходим в каталог загрузки SD-карты с помощью файлового менеджера ОС и там создаем новый пустой файл с именем ssh без расширения внутри загрузочного каталога
10. Меняем пароль от RaspPi
```sudo passwd pi```

#### Инструкция по установке FriendlyARM на NanoPi Neo. 
1. Скачиваем Ether с официального [сайта](https://www.etcher.io/)
2. Скачиваем образ системы гугл диска [FriendlyARM](https://drive.google.com/file/d/1CRC6YjaXsXpDloD-K7CGjQWDwzKxk7dF/view?usp=sharing)
4. Подключаем microSD карту к компьютеру
5. Форматируем microSD карту в формате FAT32 перед записью нового образа.
6. В Ether нажимаем Flash from file, выбираем архив с образом системы, который скачали (распаковывать не нужно)
7. Нажимаем Select target и выбираем подключенную microSD карту
8. Нажимаем Flash! Образ системы начнет записываться на карту
9. После записи можно вставлять карту в NanoPi Neo, подключаться по ssh (пользователь: pi, пароль: pi)
10. Меняем пароль от системы следующим образом: ```passwd```, вводим старый пароль и два раза новый. После успешной смены должно выйти: ```password updated successfully```

#### Инструкция по установке mqtt брокера на RaspberryPi/NanoPi Neo.
1. Чтобы каждый раз не вводить sudo перед командой, вводим ```sudo su```
2. Обновляем систему ```apt-get update``` 
3. Устанавливаем Midnight Commander ```apt-get install mc -y```
4. Устанавливаем MQTT брокер (сервер): ```apt-get install mosquitto -y```
5. Добавляем брокер к автозапуск, чтобы при перезагрузке не нужно было запускать вручную ```systemctl enable mosquitto```
6. Открываем порт 1883 ```ufw allow 1883/tcp```, если он еще не открыт. Если же он уже открыт, то выйдет ошибка. Ее игнорируем
7. Останавливаем сервер для настройки ```sudo /etc/init.d/mosquitto stop```
8. Открываем mosquitto.conf ```sudo nano /etc/mosquitto/mosquitto.conf```
9. Заменяем содержимое на
```
# Place your local configuration in /etc/mosquitto/conf.d/
#
# A full description of the configuration file is at
# /usr/share/doc/mosquitto/examples/mosquitto.conf.example

pid_file /var/run/mosquitto.pid

persistence true
persistence_location /var/lib/mosquitto/

log_dest topic

log_type error
log_type warning
log_type notice
log_type information

connection_messages true
log_timestamp true

include_dir /etc/mosquitto/conf.d
```
10. Сохраняем, закрываем программу nano и выходим обратно в терминал (ctrl+o, Enter, ctrl+x)
11. Запускаем брокера ```sudo /etc/init.d/mosquitto start``` и проверяем статус ```sudo /etc/init.d/mosquitto status```
В прошивку еще не добавлено, делать не нужно
12. Устанавливаем пароль ```sudo mosquitto_passwd -c /etc/mosquitto/passwd <username>```
13. В файл```sudo nano /etc/mosquitto/conf.d/default.conf``` добавляем
```
allow_anonymous false
password_file /etc/mosquitto/passwd
```
14. Перезапускаем брокера ```sudo systemctl restart mosquitto```

### Инструкция по установке FLIP и драйверов
Внимание! На win10 не удалось установить драйвера на AT90USB162. Процесс будет описан для win7, запущенной в виртуальной машине
1. Скачиваем FLIP с официального сайта [Atmel](https://ww1.microchip.com/downloads/en/DeviceDoc/JRE%20-%20Flip%20Installer%20-%203.4.7.112.exe)
2. Установка стандартная, после установки подключаем AT90USB162 к ПК и он должен определиться в диспетчере устройств как "Неизвестное устройство"
3. Нажимаем правой кнопкой мыши на «Неизвестное устройство»
4. В выпадающем меню нажимаем «Свойства»
5. Переходим на вкладку «Драйвер»
6. Нажимаем «Обновить»
7. Нажимаем «Выбрать драйвер из списка уже установленных драйверов». Драйвера находятся в директории, в которую был установлен Flip, в папке «usb»

### Инструкция по прошивке контроллеров
1. Перед прошивкой Wemos d1 mini его необходимо извлечь из печатной платы
2. Через ArduinoIDE прошиваем Wemos d1 mini файлом "WemosMini.ino"
3. Отключить USB кабель, поставить перемычку между пином D7 (можно изменить в прошивке) и GND
4. Подключить USB кабель, подождать 15 секунд, убрать перемычку, перезагрузить Wemos d1 mini
5. Убедиться, что после перезагрузки, появилась точка доступа ESPap. Wemos d1 mini готов к работе, можно возвращать его в печатную плату.
6. Открываем в FLIP файл "GccApplication1.hex"
7. Подключаем к разъему X2 на печатной плате USB переходник
8. Устанавливаем перемычку X4 и подключаем Wemos d1 mini к ПК (чтобы запитать контроллеры). Запищит бипер, не пугаемся :)
9. Ставим и убираем перемычку X1
10. В FLIP подключаемся к контроллеру, нажимаем RUN
11. После завершения прошивки отключаем d1 mini от ПК , убираем перемычку X2, убираем USB
12. Подаем питание. На дисплее должны светиться все восьмерки, бипер пищать не должен

### Подключение к своему WiFi и установка параметров MQTT брокера (удалено)
1. Включаем питание
2. Подключаемся к WiFi сети ESPap. Пароль password
3. В браузере в строке адреса вводим 192.168.4.1
4. Должна открыться приветственная страничка, в которой вводим SSID, пароль, IP адрес MQTT брокера
5. Сохраняем, перезагружаем. ESP после перезагрузки должна подкючиться к заданной точке доступа и брокеру

### Конфигурирование клиента на Android
1. В Google Play скачиваем [Lazy MQTT Free](https://play.google.com/store/apps/details?id=org.mpru.a2.free&hl=ru&gl=US)
2. Копируем в буфер весь код из smartheat.txt. При копиравании убеждаемся, что в коде корректно отображаются русские буквы (я копировал через Total Commander).
3. Открываваем Lazy MQTT Free и нажимаем на шестеренку в правом верхнем углу -> три точки -> Настройки -> Импорт из буфера
4. Нажимаем на шестеренку в правом верхнем углу -> три точки -> Соединения -> NanoPi. Вводим IP адрес брокера, имя пользователя и пароль. Нажимаем попробовать соединиться. Если сделали все правильно, внизу должно выйти сообщение "Соединение установлено"
5. При необходимости задать пароль доступа к настройкам: Нажимаем на шестеренку в правом верхнем углу -> три точки -> Установки -> Пароль 

### Протокол обмена (UART) между AT90USB162 и Wemos D1 mini
* 1 байт - Старший байт верхнего числа  
* 2 байт - Младший байт верхнего числа  
* 3 байт - Старший байт нижнего числа  
* 4 байт - Младший байт нижнего числа  
* 5 байт:  
    * 0 бит - Резерв  
    * 1 бит - Резерв  
    * 2 бит - Резерв  
    * 3 бит - Новое состояние бипера  
    * 4 бит - Новое состояние реле 1  
    * 5 бит - Новое состояние реле 2  
    * 6 бит - Резерв  
    * 7 бит - Резерв  
  
### Структура топиков
_Для_ _других_ _девайсов_ _в_ _сети_ _заменить_ _device1_ _на_ _device2_ _итд_

#### С контроллера на планшет
* smartheat/device1/temp - Топик для отправки температуры с контроллера на планшет
* smartheat/device1/current - Топик для отправки тока с контроллера на планшет
* smartheat/device1/ir - Топик для отправки состояния ИК датчика с контроллера на планшет
* smartheat/device1/time_left - Топик для отправки времени до завершения работы с контроллера на планшет

#### С планшета на контроллер
* smartheat/device1/cave - Отправка флага сохранения текущих настроек в энергонезависимую память

#### Двунаправленные
* smartheat/device1/set_mode - Номер режима, который нужно активировать (0...6). В нем же ответ контроллера по завершению режима
* smartheat/device1/rel_sel - Тип используемого реле (твердотельное - 0, ЭМ - 1)
* smartheat/device1/curr_sel - Использовать или нет датчик тока
* smartheat/device1/k_feedback - Коэффициент обратной связи нагревателя
* smartheat/device1/hyster - Гистерезис
* smartheat/device1/mode1/set_temp - ... - smartheat/device1/mode6/set_temp - Значение температуры для соответствующего режима
* smartheat/device1/mode1/set_time - ... - smartheat/device1/mode6/set_time - Значение времени работы для соответствующего режима

### Параметры, доступные для настройки в скетче
_Config.h_ 

* SSID_DEFAULT "Keenetic-1490"	- Сеть WiFi 
* PASS_DEFAULT "NDkmLoKG"		- Пароль от WiFi 
* IP_DEFAULT "192.168.1.64"		- IP адрес брокера 
* BROKER_USERNAME "mqtt"		- Логин для авторизации на брокере 
* BROKER_PASS "mqtt"			- Пароль для авторизации на брокере 
 
_main.h_

* UART_pwr_pin D4 - Питание усилителя UART линии 
* TEN_pin D2 - Номер пина твердотельного реле 
* AM_pin A0             - Номер АНАЛОГОВОГО пина AM_pin (датчик тока) 
* thermoDO D6           - Номера пинов термопары 
* thermoCS D0 
* thermoCLK D5 
* IR_pin D1             - Номер пина ИК датчика препятствий 

* OTAUSER         "admin"     - Логин для входа в OTA 
* OTAPASSWORD     "admin"     - Пароль для входа в ОТА 
* OTAPATH         "/firmware" - Путь, который будем дописывать после ip адреса в браузере. 
* SERVERPORT      80          - Порт для входа, он стандартный 80 это порт http 
